<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Urban Assistant</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #12112b; --surface: #1a1835; --card: #1e1c3a;
  --border: #2d2a5e; --accent: #7c6ef5; --accent2: #a78bfa;
  --green: #34d399; --red: #f87171; --yellow: #fbbf24;
  --text: #e2e0ff; --muted: #6b68a0;
  --glass: rgba(124,110,245,0.08);
  --glow: rgba(124,110,245,0.25);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
body::before {
  content: ''; position: fixed; inset: 0;
  background:
    radial-gradient(ellipse at 20% 0%, rgba(124,110,245,0.18) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 100%, rgba(167,139,250,0.12) 0%, transparent 60%);
  pointer-events: none; z-index: 0;
}
.app { position: relative; z-index: 1; max-width: 430px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: 80px; }

/* Header */
.header { padding: 16px 20px 0; display: flex; align-items: center; justify-content: space-between; }
.logo { display: flex; align-items: center; gap: 10px; }
.logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg,var(--accent),var(--accent2)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 17px; box-shadow: 0 0 20px var(--glow); }
.logo-text { font-size: 1rem; font-weight: 800; }
.logo-sub { font-size: 0.6rem; color: var(--muted); font-family: 'JetBrains Mono'; }
.header-date { text-align: right; font-family: 'JetBrains Mono'; font-size: 0.65rem; color: var(--muted); line-height: 1.6; }

/* Nav tabs */
.nav { display: flex; gap: 6px; padding: 14px 20px 0; overflow-x: auto; scrollbar-width: none; }
.nav::-webkit-scrollbar { display: none; }
.nav-btn { flex-shrink: 0; display: flex; align-items: center; gap: 5px; padding: 7px 14px; border-radius: 20px; border: 1px solid var(--border); background: var(--card); color: var(--muted); font-family: 'Syne'; font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.nav-btn.active { background: linear-gradient(135deg,rgba(124,110,245,0.25),rgba(167,139,250,0.15)); border-color: var(--accent); color: var(--text); box-shadow: 0 0 12px var(--glow); }

/* Content */
.content { flex: 1; padding: 16px 20px; }

/* Section title */
.section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.section-title h3 { font-size: 0.85rem; font-weight: 700; }
.section-title a { font-size: 0.68rem; color: var(--accent); font-family: 'JetBrains Mono'; cursor: pointer; }

/* Balance card */
.balance-card {
  background: linear-gradient(135deg, #1e1b4b 0%, #2d1f6e 50%, #1a1835 100%);
  border: 1px solid rgba(124,110,245,0.3);
  border-radius: 24px; padding: 20px; margin-bottom: 14px;
  position: relative; overflow: hidden;
  box-shadow: 0 8px 32px rgba(124,110,245,0.2);
}
.balance-card::before { content: ''; position: absolute; top: -40px; right: -40px; width: 160px; height: 160px; background: radial-gradient(circle,rgba(124,110,245,0.25),transparent 70%); border-radius: 50%; }
.balance-card::after { content: ''; position: absolute; bottom: -20px; left: 20px; width: 80px; height: 80px; background: radial-gradient(circle,rgba(167,139,250,0.15),transparent 70%); border-radius: 50%; }
.balance-label { font-family: 'JetBrains Mono'; font-size: 0.65rem; color: rgba(224,220,255,0.6); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
.balance-amount { font-size: 2.2rem; font-weight: 800; letter-spacing: -2px; background: linear-gradient(135deg,#fff,var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 16px; }
.balance-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.bal-item { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 8px; text-align: center; backdrop-filter: blur(10px); }
.bal-val { font-family: 'JetBrains Mono'; font-size: 0.8rem; font-weight: 600; }
.bal-name { font-size: 0.58rem; color: var(--muted); margin-top: 2px; }

/* Empty state */
.empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
.empty-state .ei { font-size: 2.5rem; margin-bottom: 12px; }
.empty-state .et { font-size: 0.85rem; font-weight: 600; color: var(--text); margin-bottom: 6px; }
.empty-state .es { font-size: 0.72rem; line-height: 1.6; }

/* Work section */
.work-header { display: flex; justify-content: space-between; align-items: center; background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px 16px; margin-bottom: 10px; }
.work-total { background: linear-gradient(135deg,rgba(124,110,245,0.12),rgba(167,139,250,0.08)); border: 1px solid rgba(124,110,245,0.2); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
.work-total-label { font-size: 0.6rem; color: var(--muted); font-family: 'JetBrains Mono'; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
.work-total-val { font-size: 1.4rem; font-weight: 800; font-family: 'JetBrains Mono'; }

/* Job card */
.job-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 8px; overflow: hidden; }
.job-header { display: flex; align-items: center; gap: 10px; padding: 14px 16px; cursor: pointer; }
.job-header.open { border-bottom: 1px solid var(--border); }
.job-color { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.job-name { flex: 1; font-size: 0.85rem; font-weight: 700; }
.job-income { font-family: 'JetBrains Mono'; font-size: 0.82rem; font-weight: 600; color: var(--green); }
.job-arrow { font-size: 0.6rem; color: var(--muted); transition: transform 0.25s; }
.job-arrow.open { transform: rotate(90deg); }
.job-body { display: none; padding: 14px 16px; }
.job-body.open { display: block; animation: fadeUp 0.2s ease; }
.job-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 14px; }
.jstat { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 10px; text-align: center; }
.jstat-val { font-size: 0.9rem; font-weight: 700; font-family: 'JetBrains Mono'; }
.jstat-label { font-size: 0.58rem; color: var(--muted); margin-top: 3px; }
.job-notes-title { font-size: 0.68rem; color: var(--muted); font-family: 'JetBrains Mono'; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
.job-note { display: flex; gap: 8px; margin-bottom: 8px; font-size: 0.75rem; line-height: 1.5; }
.note-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
.note-date { font-size: 0.6rem; color: var(--muted); font-family: 'JetBrains Mono'; }
.add-note-btn { width: 100%; padding: 8px; background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1); border-radius: 10px; color: var(--muted); font-family: 'Syne'; font-size: 0.72rem; cursor: pointer; }
.add-job-btn { width: 100%; padding: 14px; background: rgba(124,110,245,0.08); border: 1px dashed rgba(124,110,245,0.3); border-radius: 14px; color: var(--accent); font-family: 'Syne'; font-size: 0.8rem; font-weight: 600; cursor: pointer; margin-top: 4px; }

/* Tasks */
.task-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 14px; margin-bottom: 8px; position: relative; overflow: hidden; transition: transform 0.3s; touch-action: pan-y; }
.task-check { width: 22px; height: 22px; border-radius: 7px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
.task-check.done { background: var(--green); border-color: var(--green); color: white; }
.task-info { flex: 1; }
.task-text { font-size: 0.82rem; font-weight: 600; margin-bottom: 2px; }
.task-text.done { text-decoration: line-through; color: var(--muted); }
.task-date { font-size: 0.62rem; color: var(--muted); font-family: 'JetBrains Mono'; }
.task-priority { font-size: 0.58rem; font-weight: 700; font-family: 'JetBrains Mono'; padding: 3px 7px; border-radius: 6px; flex-shrink: 0; }
.task-priority.high { background: rgba(248,113,113,0.15); color: var(--red); }
.task-priority.mid { background: rgba(251,191,36,0.15); color: var(--yellow); }
.task-priority.low { background: rgba(52,211,153,0.15); color: var(--green); }

/* Swipe delete */
.swipe-item { position: relative; overflow: hidden; border-radius: 14px; margin-bottom: 8px; }
.swipe-inner { position: relative; z-index: 1; transition: transform 0.3s ease; touch-action: pan-y; }
.swipe-delete-bg { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; background: var(--red); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border-radius: 14px; z-index: 0; }

/* Finance */
.fin-subtab { flex: 1; padding: 9px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--muted); font-family: 'Syne'; font-size: 0.68rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
.fin-subtab.active { background: rgba(124,110,245,0.15); border-color: var(--accent); color: var(--text); }
.finance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.fin-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
.fin-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
.fin-card.income::before { background: var(--green); }
.fin-card.expense::before { background: var(--red); }
.fin-card.invest::before { background: var(--accent); }
.fin-card.work-fin::before { background: var(--yellow); }
.fin-card:active { transform: scale(0.97); }
.fin-card-icon { font-size: 1.4rem; margin-bottom: 8px; display: block; }
.fin-card-label { font-size: 0.6rem; color: var(--muted); font-family: 'JetBrains Mono'; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
.fin-card-val { font-size: 1rem; font-weight: 800; font-family: 'JetBrains Mono'; }
.fin-card-val.green { color: var(--green); }
.fin-card-val.red { color: var(--red); }
.fin-card-val.blue { color: var(--accent); }
.fin-card-val.yellow { color: var(--yellow); }

/* Charts */
.chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 16px; margin-bottom: 14px; }
.chart-title { font-size: 0.78rem; font-weight: 700; margin-bottom: 14px; }

/* Transaction list */
.txn-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 14px; }
.txn-ico { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
.txn-info { flex: 1; }
.txn-name { font-size: 0.8rem; font-weight: 600; margin-bottom: 2px; }
.txn-date { font-size: 0.6rem; color: var(--muted); font-family: 'JetBrains Mono'; }
.txn-amt { font-family: 'JetBrains Mono'; font-size: 0.85rem; font-weight: 700; }

/* Notes */
.note-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
.note-card-title { font-size: 0.82rem; font-weight: 700; margin-bottom: 4px; }
.note-card-date { font-size: 0.6rem; color: var(--muted); font-family: 'JetBrains Mono'; margin-bottom: 8px; }
.note-card-text { font-size: 0.75rem; color: var(--muted); line-height: 1.6; }

/* Calendar */
.calendar-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 16px; margin-bottom: 14px; }
.cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.cal-title { font-size: 0.9rem; font-weight: 700; }
.cal-nav { display: flex; gap: 8px; }
.cal-nav-btn { width: 28px; height: 28px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.cal-days-header { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; margin-bottom: 6px; }
.cal-day-name { text-align: center; font-size: 0.58rem; color: var(--muted); font-family: 'JetBrains Mono'; padding: 4px 0; }
.cal-days { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }
.cal-day { text-align: center; padding: 6px 2px; font-size: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; position: relative; }
.cal-day:hover { background: rgba(255,255,255,0.06); }
.cal-day.today { background: linear-gradient(135deg,var(--accent),var(--accent2)); color: white; font-weight: 700; box-shadow: 0 4px 12px var(--glow); }
.cal-day.has-event::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--yellow); }
.cal-day.other-month { color: var(--muted); opacity: 0.4; }
.cal-day.selected { background: rgba(124,110,245,0.2); border: 1px solid var(--accent); }

/* Events list */
.event-item { display: flex; gap: 12px; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 14px; }
.event-time { font-family: 'JetBrains Mono'; font-size: 0.68rem; color: var(--accent); min-width: 42px; }
.event-dot { width: 3px; background: var(--accent); border-radius: 99px; flex-shrink: 0; }
.event-info { flex: 1; }
.event-name { font-size: 0.8rem; font-weight: 600; margin-bottom: 2px; }
.event-meta { font-size: 0.62rem; color: var(--muted); font-family: 'JetBrains Mono'; }

/* Invest */
.inv-asset { background: var(--card); border: 1px solid var(--border); border-radius: 14px; }
.cur-btn { padding: 9px 4px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; color: var(--muted); font-family: 'Syne'; font-size: 0.68rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
.cur-btn.active { background: linear-gradient(135deg,rgba(124,110,245,0.2),rgba(167,139,250,0.2)); border-color: var(--accent); color: var(--text); }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(18,17,43,0.85); backdrop-filter: blur(12px); z-index: 100; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 24px 24px 0 0; padding: 24px 20px 36px; width: 100%; transform: translateY(100%); transition: transform 0.3s ease; }
.modal-overlay.open .modal { transform: translateY(0); }
.modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 99px; margin: 0 auto 20px; }
.modal-title { font-size: 1rem; font-weight: 800; margin-bottom: 16px; }
.modal-input { width: 100%; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 13px 14px; color: var(--text); font-family: 'Syne'; font-size: 0.85rem; margin-bottom: 10px; outline: none; }
.modal-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(124,110,245,0.15); }
.modal-label { font-size: 0.65rem; color: var(--muted); font-family: 'JetBrains Mono'; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
.modal-btn { width: 100%; padding: 14px; background: linear-gradient(135deg,var(--accent),var(--accent2)); border: none; border-radius: 14px; color: white; font-family: 'Syne'; font-size: 0.9rem; font-weight: 700; cursor: pointer; margin-bottom: 8px; box-shadow: 0 4px 16px var(--glow); }
.modal-cancel { width: 100%; padding: 12px; background: transparent; border: 1px solid var(--border); border-radius: 14px; color: var(--muted); font-family: 'Syne'; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
.color-pick { display: flex; gap: 8px; margin-bottom: 16px; }
.color-opt { width: 28px; height: 28px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
.color-opt.selected { border-color: white; transform: scale(1.15); }

/* Priority select */
.priority-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 12px; }
.pri-btn { padding: 8px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--muted); font-family: 'Syne'; font-size: 0.68rem; font-weight: 700; cursor: pointer; text-align: center; }
.pri-btn.active-high { background: rgba(248,113,113,0.15); border-color: var(--red); color: var(--red); }
.pri-btn.active-mid { background: rgba(251,191,36,0.15); border-color: var(--yellow); color: var(--yellow); }
.pri-btn.active-low { background: rgba(52,211,153,0.15); border-color: var(--green); color: var(--green); }

/* Confirm dialog */
.confirm-overlay { position: fixed; inset: 0; background: rgba(18,17,43,0.85); backdrop-filter: blur(12px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; padding: 20px; }
.confirm-overlay.open { opacity: 1; pointer-events: all; }
.confirm-box { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 24px; width: 100%; max-width: 320px; text-align: center; transform: scale(0.9); transition: transform 0.2s; }
.confirm-overlay.open .confirm-box { transform: scale(1); }
.confirm-icon { font-size: 2.5rem; margin-bottom: 12px; }
.confirm-title { font-size: 0.95rem; font-weight: 800; margin-bottom: 6px; }
.confirm-text { font-size: 0.75rem; color: var(--muted); margin-bottom: 20px; line-height: 1.5; }
.confirm-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.confirm-yes { padding: 12px; background: var(--red); border: none; border-radius: 12px; color: white; font-family: 'Syne'; font-size: 0.82rem; font-weight: 700; cursor: pointer; }
.confirm-no { padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'Syne'; font-size: 0.82rem; font-weight: 700; cursor: pointer; }

/* Bottom nav */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 430px; margin: 0 auto; background: rgba(18,17,43,0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border); padding: 10px 12px 20px; display: flex; gap: 4px; z-index: 50; }
.bot-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 7px 4px; border-radius: 12px; border: none; background: transparent; color: var(--muted); font-family: 'Syne'; font-size: 0.55rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.bot-btn.active { color: var(--accent); background: rgba(124,110,245,0.12); }
.bot-btn span { font-size: 1.1rem; }

/* FAB */
.fab { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: linear-gradient(135deg,var(--accent),var(--accent2)); border-radius: 15px; border: none; color: white; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 8px 24px var(--glow); z-index: 10; transition: transform 0.2s; }
.fab:active { transform: scale(0.93); }

@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="logo">
      <div class="logo-icon">üèô</div>
      <div>
        <div class="logo-text">Urban Assistant</div>
        <div class="logo-sub">PERSONAL OS</div>
      </div>
    </div>
    <div class="header-date" id="header-date"></div>
    <button onclick="manualSync()" style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:10px;color:var(--accent);font-size:0.7rem;padding:6px 10px;font-family:'Syne';cursor:pointer" id="sync-btn">üîÑ</button>
  </div>

  <!-- Nav -->
  <div class="nav">
    <button class="nav-btn active" onclick="showTab('dashboard',this)"><span>üìä</span>–î–∞—à–±–æ—Ä–¥</button>
    <button class="nav-btn" onclick="showTab('work',this)"><span>üíº</span>–†–æ–±–æ—Ç–∞</button>
    <button class="nav-btn" onclick="showTab('planner',this)"><span>üìÖ</span>–ü–ª–∞–Ω–µ—Ä</button>
    <button class="nav-btn" onclick="showTab('tasks',this)"><span>‚úÖ</span>–ó–∞–≤–¥–∞–Ω–Ω—è</button>
    <button class="nav-btn" onclick="showTab('finance',this)"><span>üí∞</span>–§—ñ–Ω–∞–Ω—Å–∏</button>
    <button class="nav-btn" onclick="showTab('notes',this)"><span>üìù</span>–ù–æ—Ç–∞—Ç–∫–∏</button>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div id="tab-dashboard">
      <div class="balance-card">
        <div class="balance-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å</div>
        <div class="balance-amount" id="dash-balance">‚Ç¥0</div>
        <div class="balance-row">
          <div class="bal-item"><div class="bal-val" style="color:var(--green)" id="dash-income">‚Ç¥0</div><div class="bal-name">–î–æ—Ö—ñ–¥</div></div>
          <div class="bal-item"><div class="bal-val" style="color:var(--red)" id="dash-expense">‚Ç¥0</div><div class="bal-name">–í–∏—Ç—Ä–∞—Ç–∏</div></div>
          <div class="bal-item"><div class="bal-val" style="color:var(--accent)" id="dash-invest">$0</div><div class="bal-name">–Ü–Ω–≤–µ—Å—Ç.</div></div>
        </div>
      </div>

      <div class="section-title"><h3>üìã –°—å–æ–≥–æ–¥–Ω—ñ</h3><a onclick="showTab('tasks')">–í—Å—ñ ‚Üí</a></div>
      <div id="dash-tasks-list">
        <div class="empty-state"><div class="ei">‚úÖ</div><div class="et">–ó–∞–≤–¥–∞–Ω—å –Ω–µ–º–∞—î</div><div class="es">–î–æ–¥–∞–π –ø–µ—Ä—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è</div></div>
      </div>
    </div>

    <!-- WORK -->
    <div id="tab-work" style="display:none">
      <div class="work-header">
        <div style="font-size:0.85rem;font-weight:700">üíº –ú–æ—ó —Ä–æ–±–æ—Ç–∏</div>
        <div style="font-size:0.65rem;color:var(--muted);font-family:'JetBrains Mono'" id="jobs-count">0 –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤</div>
      </div>
      <div class="work-total">
        <div><div class="work-total-label">–ó–ê–ì–ê–õ–¨–ù–ò–ô –î–û–•–Ü–î</div><div class="work-total-val" id="work-total">‚Ç¥0</div></div>
        <div style="text-align:right"><div class="work-total-label">–ü–Ü–î–†–û–ó–î–Ü–õ–Ü–í</div><div style="font-size:1rem;color:var(--accent);font-family:'JetBrains Mono';font-weight:700" id="work-count2">0</div></div>
      </div>
      <div id="jobs-list">
        <div class="empty-state"><div class="ei">üíº</div><div class="et">–ù–µ–º–∞—î –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤</div><div class="es">–î–æ–¥–∞–π –ø–µ—Ä—à—É —Ä–æ–±–æ—Ç—É –∞–±–æ –ø—Ä–æ–µ–∫—Ç</div></div>
      </div>
      <button class="add-job-btn" onclick="openModal('modal-add-job')">Ôºã –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Ä–æ–±–æ—Ç—É / –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª</button>
    </div>

    <!-- PLANNER -->
    <div id="tab-planner" style="display:none">
      <div class="calendar-wrap">
        <div class="cal-header">
          <div class="cal-title" id="cal-month-title"></div>
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
            <button class="cal-nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
          </div>
        </div>
        <div class="cal-days-header">
          <div class="cal-day-name">–ü–Ω</div><div class="cal-day-name">–í—Ç</div><div class="cal-day-name">–°—Ä</div>
          <div class="cal-day-name">–ß—Ç</div><div class="cal-day-name">–ü—Ç</div>
          <div class="cal-day-name" style="color:var(--yellow)">–°–±</div><div class="cal-day-name" style="color:var(--red)">–ù–¥</div>
        </div>
        <div class="cal-days" id="cal-days"></div>
      </div>
      <div class="section-title"><h3 id="cal-events-title">–ü–æ–¥—ñ—ó –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h3><a onclick="openModal('modal-add-event')">+ –î–æ–¥–∞—Ç–∏</a></div>
      <div id="events-list">
        <div class="empty-state"><div class="ei">üìÖ</div><div class="et">–ù–µ–º–∞—î –ø–æ–¥—ñ–π</div><div class="es">–ù–∞—Ç–∏—Å–Ω–∏ "+ –î–æ–¥–∞—Ç–∏" —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–¥—ñ—é</div></div>
      </div>
    </div>

    <!-- TASKS -->
    <div id="tab-tasks" style="display:none">
      <div class="section-title"><h3>‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è</h3><a onclick="openModal('modal-add-task')">+ –î–æ–¥–∞—Ç–∏</a></div>
      <div id="tasks-list">
        <div class="empty-state"><div class="ei">‚úÖ</div><div class="et">–ó–∞–≤–¥–∞–Ω—å –Ω–µ–º–∞—î</div><div class="es">–î–æ–¥–∞–π –ø–µ—Ä—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–∞—Ç–∏—Å–Ω—É–≤—à–∏ "+ –î–æ–¥–∞—Ç–∏"</div></div>
      </div>
    </div>

    <!-- FINANCE -->
    <div id="tab-finance" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <button class="fin-subtab active" id="fst-overview" onclick="showFinSub('overview')">üí≥ –û–≥–ª—è–¥</button>
        <button class="fin-subtab" id="fst-invest" onclick="showFinSub('invest')">üìà –Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—ó</button>
      </div>

      <!-- Overview -->
      <div id="fin-overview">
        <div class="finance-grid">
          <div class="fin-card income" onclick="openFinModal('–î–æ—Ö—ñ–¥')">
            <span class="fin-card-icon">‚ûï</span>
            <div class="fin-card-label">–î–û–•–Ü–î</div>
            <div class="fin-card-val green" id="fin-income-total">‚Ç¥0</div>
          </div>
          <div class="fin-card expense" onclick="openFinModal('–í–∏—Ç—Ä–∞—Ç–∞')">
            <span class="fin-card-icon">‚ûñ</span>
            <div class="fin-card-label">–í–ò–¢–†–ê–¢–ê</div>
            <div class="fin-card-val red" id="fin-expense-total">‚Ç¥0</div>
          </div>
          <div class="fin-card invest" onclick="showFinSub('invest')">
            <span class="fin-card-icon">üìà</span>
            <div class="fin-card-label">–Ü–ù–í–ï–°–¢–ò–¶–Ü–á</div>
            <div class="fin-card-val blue" id="fin-invest-total">$0</div>
          </div>
          <div class="fin-card work-fin" onclick="showTab('work')">
            <span class="fin-card-icon">üíº</span>
            <div class="fin-card-label">–†–û–ë–û–¢–ê</div>
            <div class="fin-card-val yellow" id="fin-work-total">‚Ç¥0</div>
          </div>
        </div>
        <div class="section-title"><h3>üìã –û—Å—Ç–∞–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó</h3></div>
        <!-- Income vs Expense donut chart -->
        <div class="chart-card" style="margin-bottom:14px">
          <div class="chart-title">üìä –î–æ—Ö–æ–¥–∏ vs –í–∏—Ç—Ä–∞—Ç–∏</div>
          <div style="display:flex;align-items:center;gap:20px">
            <div style="position:relative;flex-shrink:0">
              <svg id="fin-donut" width="110" height="110" viewBox="0 0 110 110">
                <circle cx="55" cy="55" r="40" fill="none" stroke="var(--border)" stroke-width="14"/>
                <circle id="fin-donut-income" cx="55" cy="55" r="40" fill="none" stroke="var(--green)" stroke-width="14" stroke-dasharray="0 251" stroke-linecap="round" transform="rotate(-90 55 55)" style="transition:stroke-dasharray 0.6s ease"/>
                <circle id="fin-donut-expense" cx="55" cy="55" r="40" fill="none" stroke="var(--red)" stroke-width="14" stroke-dasharray="0 251" stroke-linecap="round" transform="rotate(-90 55 55)" stroke-dashoffset="0" style="transition:stroke-dasharray 0.6s ease"/>
              </svg>
              <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
                <div id="fin-donut-pct" style="font-size:1rem;font-weight:800;font-family:'JetBrains Mono'">‚Äî</div>
                <div style="font-size:0.55rem;color:var(--muted)">ROI</div>
              </div>
            </div>
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <div style="width:10px;height:10px;border-radius:50%;background:var(--green);flex-shrink:0"></div>
                <div style="flex:1">
                  <div style="font-size:0.68rem;color:var(--muted)">–î–æ—Ö—ñ–¥</div>
                  <div style="font-size:0.9rem;font-weight:700;font-family:'JetBrains Mono';color:var(--green)" id="fin-chart-income">‚Ç¥0</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div style="width:10px;height:10px;border-radius:50%;background:var(--red);flex-shrink:0"></div>
                <div style="flex:1">
                  <div style="font-size:0.68rem;color:var(--muted)">–í–∏—Ç—Ä–∞—Ç–∏</div>
                  <div style="font-size:0.9rem;font-weight:700;font-family:'JetBrains Mono';color:var(--red)" id="fin-chart-expense">‚Ç¥0</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="txn-list">
          <div class="empty-state"><div class="ei">üí≥</div><div class="et">–û–ø–µ—Ä–∞—Ü—ñ–π –Ω–µ–º–∞—î</div><div class="es">–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–∫—É –≤–∏—â–µ —â–æ–± –¥–æ–¥–∞—Ç–∏</div></div>
        </div>
      </div>

      <!-- Invest -->
      <div id="fin-invest" style="display:none">
        <div class="work-header">
          <div style="font-size:0.85rem;font-weight:700">üìà –ú–æ—ó —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—ó</div>
          <div style="font-size:0.65rem;color:var(--muted);font-family:'JetBrains Mono'" id="inv-count">0 –∞–∫—Ç–∏–≤—ñ–≤</div>
        </div>
        <div class="work-total" style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(59,130,246,0.1))">
          <div>
            <div class="work-total-label">üíµ USD / USDT</div>
            <div class="work-total-val" style="color:var(--green)" id="inv-total">$0</div>
          </div>
          <div style="text-align:center">
            <div class="work-total-label">üá∫üá¶ UAH</div>
            <div class="work-total-val" style="color:var(--yellow)" id="inv-total-uah">‚Ç¥0</div>
          </div>
          <div style="text-align:right">
            <div class="work-total-label">–ê–ö–¢–ò–í–Ü–í</div>
            <div style="font-size:1rem;color:var(--accent);font-family:'JetBrains Mono';font-weight:700" id="inv-count2">0</div>
          </div>
        </div>
        <div id="inv-list">
          <div class="empty-state"><div class="ei">üìà</div><div class="et">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤—ñ–≤</div><div class="es">–î–æ–¥–∞–π –ø–µ—Ä—à–∏–π —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π–Ω–∏–π –∞–∫—Ç–∏–≤</div></div>
        </div>
        <!-- Investment donut chart -->
        <div class="chart-card" id="inv-chart-card" style="display:none">
          <div class="chart-title">ü•ß –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ—Ä—Ç—Ñ–µ–ª—è</div>
          <div style="display:flex;align-items:center;gap:16px">
            <div style="position:relative;flex-shrink:0">
              <svg id="inv-donut" width="110" height="110" viewBox="0 0 110 110"></svg>
              <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
                <div id="inv-donut-center" style="font-size:0.75rem;font-weight:800;font-family:'JetBrains Mono';text-align:center;line-height:1.3"></div>
              </div>
            </div>
            <div style="flex:1" id="inv-legend"></div>
          </div>
        </div>
        <button class="add-job-btn" onclick="openModal('modal-add-invest')">Ôºã –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –∞–∫—Ç–∏–≤</button>
      </div>
    </div>

    <!-- NOTES -->
    <div id="tab-notes" style="display:none">
      <div class="section-title"><h3>üìù –ù–æ—Ç–∞—Ç–∫–∏</h3><a onclick="openModal('modal-add-note')">+ –î–æ–¥–∞—Ç–∏</a></div>
      <div id="notes-list">
        <div class="empty-state"><div class="ei">üìù</div><div class="et">–ù–æ—Ç–∞—Ç–æ–∫ –Ω–µ–º–∞—î</div><div class="es">–°–≤–∞–π–ø –≤–ª—ñ–≤–æ —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É</div></div>
      </div>
    </div>

  </div><!-- end content -->

  <button class="fab" onclick="fabAction()">Ôºã</button>

  <div class="bottom-nav">
    <button class="bot-btn active" onclick="switchBottom(this,'dashboard')"><span>üè†</span>–ì–æ–ª–æ–≤–Ω–∞</button>
    <button class="bot-btn" onclick="switchBottom(this,'work')"><span>üíº</span>–†–æ–±–æ—Ç–∞</button>
    <button class="bot-btn" onclick="switchBottom(this,'planner')"><span>üìÖ</span>–ü–ª–∞–Ω–µ—Ä</button>
    <button class="bot-btn" onclick="switchBottom(this,'tasks')"><span>‚úÖ</span>–ó–∞–≤–¥–∞–Ω–Ω—è</button>
    <button class="bot-btn" onclick="switchBottom(this,'finance')"><span>üí∞</span>–§—ñ–Ω–∞–Ω—Å–∏</button>
    <button class="bot-btn" onclick="switchBottom(this,'notes')"><span>üìù</span>–ù–æ—Ç–∞—Ç–∫–∏</button>
  </div>
</div>

<!-- MODALS -->

<!-- Add Task -->
<div class="modal-overlay" id="modal-add-task" onclick="closeOnBg(event,'modal-add-task')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="task-modal-title">‚úÖ –ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</div>
    <input class="modal-input" id="task-text-input" placeholder="–û–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è">
    <input class="modal-input" id="task-date-input" type="date">
    <div class="modal-label">–ü–†–Ü–û–†–ò–¢–ï–¢</div>
    <div class="priority-row">
      <button class="pri-btn active-high" id="pri-high" onclick="selectPri('HIGH')">üî¥ HIGH</button>
      <button class="pri-btn" id="pri-mid" onclick="selectPri('MID')">üü° MID</button>
      <button class="pri-btn" id="pri-low" onclick="selectPri('LOW')">üü¢ LOW</button>
    </div>
    <div class="modal-label">–ü–û–í–¢–û–†–ï–ù–ù–Ø</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px" id="recurring-pick">
      <button class="pri-btn active-low" id="rec-none" onclick="selectRecurring('none')">üö´ –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ</button>
      <button class="pri-btn" id="rec-daily" onclick="selectRecurring('daily')">üîÅ –©–æ–¥–Ω—è</button>
      <button class="pri-btn" id="rec-custom" onclick="selectRecurring('custom')">üìÖ N –¥–Ω—ñ–≤</button>
    </div>
    <div id="recurring-days-wrap" style="display:none;margin-bottom:12px">
      <input class="modal-input" id="recurring-days-input" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤ (–Ω–∞–ø—Ä. 30)" type="number" min="1" max="365" style="margin-bottom:0">
    </div>
    <button class="modal-btn" onclick="saveTask()">‚úÖ –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
    <button class="modal-cancel" onclick="closeModal('modal-add-task')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Add Note -->
<div class="modal-overlay" id="modal-add-note" onclick="closeOnBg(event,'modal-add-note')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üìù –ù–æ–≤–∞ –Ω–æ—Ç–∞—Ç–∫–∞</div>
    <input class="modal-input" id="note-title-input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
    <textarea class="modal-input" id="note-text-input" placeholder="–¢–µ–∫—Å—Ç –Ω–æ—Ç–∞—Ç–∫–∏..." rows="4" style="resize:none;line-height:1.5"></textarea>
    <button class="modal-btn" onclick="saveNote()">üìù –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É</button>
    <button class="modal-cancel" onclick="closeModal('modal-add-note')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Add Finance -->
<div class="modal-overlay" id="modal-add-finance" onclick="closeOnBg(event,'modal-add-finance')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="fin-modal-title">‚ûï –î–æ—Ö—ñ–¥</div>
    <input class="modal-input" id="fin-amount-input" placeholder="–°—É–º–∞" type="number">
    <input class="modal-input" id="fin-desc-input" placeholder="–û–ø–∏—Å">
    <div class="modal-label">–í–ê–õ–Æ–¢–ê</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:16px" id="fin-currency-pick">
      <button class="cur-btn active" onclick="selectFinCur(this,'UAH')">üá∫üá¶ UAH</button>
      <button class="cur-btn" onclick="selectFinCur(this,'USD')">üá∫üá∏ USD</button>
      <button class="cur-btn" onclick="selectFinCur(this,'USDT')">üíé USDT</button>
      <button class="cur-btn" onclick="selectFinCur(this,'EUR')">üá™üá∫ EUR</button>
    </div>
    <button class="modal-btn" onclick="saveFinance()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button class="modal-cancel" onclick="closeModal('modal-add-finance')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Add Job -->
<div class="modal-overlay" id="modal-add-job" onclick="closeOnBg(event,'modal-add-job')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üíº –ù–æ–≤–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª</div>
    <input class="modal-input" id="job-name-input" placeholder="–ù–∞–∑–≤–∞ (–Ω–∞–ø—Ä. –§—Ä—ñ–ª–∞–Ω—Å, –û—Å–Ω–æ–≤–Ω–∞ —Ä–æ–±–æ—Ç–∞)">
    <input class="modal-input" id="job-income-input" placeholder="–î–æ—Ö—ñ–¥ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" type="number">
    <div class="modal-label">–ö–û–õ–Ü–†</div>
    <div class="color-pick" id="color-pick">
      <div class="color-opt selected" style="background:#3b82f6" onclick="selectColor(this,'#3b82f6')"></div>
      <div class="color-opt" style="background:#8b5cf6" onclick="selectColor(this,'#8b5cf6')"></div>
      <div class="color-opt" style="background:#10b981" onclick="selectColor(this,'#10b981')"></div>
      <div class="color-opt" style="background:#f59e0b" onclick="selectColor(this,'#f59e0b')"></div>
      <div class="color-opt" style="background:#ef4444" onclick="selectColor(this,'#ef4444')"></div>
      <div class="color-opt" style="background:#06b6d4" onclick="selectColor(this,'#06b6d4')"></div>
    </div>
    <button class="modal-btn" onclick="saveJob()">‚úÖ –î–æ–¥–∞—Ç–∏ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª</button>
    <button class="modal-cancel" onclick="closeModal('modal-add-job')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Add Invest -->
<div class="modal-overlay" id="modal-add-invest" onclick="closeOnBg(event,'modal-add-invest')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üìà –ù–æ–≤–∏–π –∞–∫—Ç–∏–≤</div>
    <input class="modal-input" id="inv-name-input" placeholder="–ù–∞–∑–≤–∞ –∞–∫—Ç–∏–≤—É">
    <input class="modal-input" id="inv-amount-input" placeholder="–°—É–º–∞" type="number">
    <div class="modal-label">–í–ê–õ–Æ–¢–ê</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:16px" id="currency-pick">
      <button class="cur-btn active" onclick="selectCur(this,'UAH')">üá∫üá¶ UAH</button>
      <button class="cur-btn" onclick="selectCur(this,'USD')">üá∫üá∏ USD</button>
      <button class="cur-btn" onclick="selectCur(this,'USDT')">üíé USDT</button>
      <button class="cur-btn" onclick="selectCur(this,'EUR')">üá™üá∫ EUR</button>
    </div>
    <div class="modal-label">–ö–û–õ–Ü–†</div>
    <div class="color-pick" id="color-pick-inv">
      <div class="color-opt selected" style="background:#3b82f6" onclick="selectColorInv(this,'#3b82f6')"></div>
      <div class="color-opt" style="background:#10b981" onclick="selectColorInv(this,'#10b981')"></div>
      <div class="color-opt" style="background:#f59e0b" onclick="selectColorInv(this,'#f59e0b')"></div>
      <div class="color-opt" style="background:#8b5cf6" onclick="selectColorInv(this,'#8b5cf6')"></div>
      <div class="color-opt" style="background:#ef4444" onclick="selectColorInv(this,'#ef4444')"></div>
      <div class="color-opt" style="background:#06b6d4" onclick="selectColorInv(this,'#06b6d4')"></div>
    </div>
    <button class="modal-btn" onclick="saveInvest()">‚úÖ –î–æ–¥–∞—Ç–∏ –∞–∫—Ç–∏–≤</button>
    <button class="modal-cancel" onclick="closeModal('modal-add-invest')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Investment Transaction Modal -->
<div class="modal-overlay" id="modal-inv-txn" onclick="closeOnBg(event,'modal-inv-txn')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="inv-txn-modal-title">üéØ –î–æ–¥–∞—Ç–∏ –¥–∏–≤—ñ–¥–µ–Ω–¥–∏</div>
    <input class="modal-input" id="inv-txn-amount" placeholder="–°—É–º–∞" type="number" step="0.01">
    <input class="modal-input" id="inv-txn-desc" placeholder="–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)">
    <button class="modal-btn" id="inv-txn-modal-btn" onclick="saveInvTxn()">üí∞ –ó–∞–ø–∏—Å–∞—Ç–∏</button>
    <button class="modal-cancel" onclick="closeModal('modal-inv-txn')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Job Note Modal -->
<div class="modal-overlay" id="modal-job-note" onclick="closeOnBg(event,'modal-job-note')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="job-note-modal-title">üìã –ù–æ—Ç–∞—Ç–∫–∞ –¥–æ –ø—Ä–æ–µ–∫—Ç—É</div>
    <textarea class="modal-input" id="job-note-input" placeholder="–í–≤–µ–¥–∏ –Ω–æ—Ç–∞—Ç–∫—É..." rows="4" style="resize:none;line-height:1.5"></textarea>
    <button class="modal-btn" onclick="saveJobNote()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button class="modal-cancel" onclick="closeModal('modal-job-note')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Job Finance Modal -->
<div class="modal-overlay" id="modal-job-fin" onclick="closeOnBg(event,'modal-job-fin')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="job-fin-title">‚ûï –î–æ—Ö—ñ–¥ –ø–æ –ø—Ä–æ–µ–∫—Ç—É</div>
    <input class="modal-input" id="job-fin-input" placeholder="–°—É–º–∞" type="number">
    <button class="modal-btn" onclick="saveJobFin()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button class="modal-cancel" onclick="closeModal('modal-job-fin')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Add Event -->
<div class="modal-overlay" id="modal-add-event" onclick="closeOnBg(event,'modal-add-event')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üìÖ –ù–æ–≤–∞ –ø–æ–¥—ñ—è</div>
    <input class="modal-input" id="event-name-input" placeholder="–ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó">
    <input class="modal-input" id="event-time-input" placeholder="–ß–∞—Å (–Ω–∞–ø—Ä. 14:00)" type="time">
    <input class="modal-input" id="event-date-input" type="date">
    <input class="modal-input" id="event-desc-input" placeholder="–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)">
    <button class="modal-btn" onclick="saveEvent()">üìÖ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–¥—ñ—é</button>
    <button class="modal-cancel" onclick="closeModal('modal-add-event')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<!-- Confirm Delete -->
<div class="confirm-overlay" id="confirm-delete">
  <div class="confirm-box">
    <div class="confirm-icon">üóëÔ∏è</div>
    <div class="confirm-title">–í–∏–¥–∞–ª–∏—Ç–∏?</div>
    <div class="confirm-text" id="confirm-text">–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –µ–ª–µ–º–µ–Ω—Ç?</div>
    <div class="confirm-btns">
      <button class="confirm-no" onclick="closeConfirm()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="confirm-yes" onclick="confirmDelete()">–í–∏–¥–∞–ª–∏—Ç–∏</button>
    </div>
  </div>
</div>

<script>
// Telegram init
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// State
let currentTab = 'dashboard';
let selectedColor = '#3b82f6';
let selectedColorInv = '#3b82f6';
let selectedCurrency = 'UAH';
let selectedFinCurrency = 'UAH';
let selectedFinType = '–î–æ—Ö—ñ–¥';
let selectedPriority = 'HIGH';
let deleteCallback = null;

// ‚îÄ‚îÄ‚îÄ Storage: Telegram CloudStorage + localStorage + Sheets sync ‚îÄ‚îÄ‚îÄ
const tgCloud = window.Telegram?.WebApp?.CloudStorage;
const SHEET_ID = '1e39cdlmFGOTjpWEdrUvOAVq0bRPbVOGPQihg8A0hGQQ';

// Track deleted sheet IDs so they don't come back on sync
let deletedSheetIds = new Set();

function saveDB() {
  const data = JSON.stringify({
    tasks, notes, jobs, investments, transactions, events,
    deletedSheetIds: [...deletedSheetIds]
  });
  try { localStorage.setItem('urban_v2', data); } catch(e) {}
  if(tgCloud) {
    tgCloud.setItem('urban_v2', data, (err) => { if(err) console.warn('Cloud save err', err); });
  }
}

async function syncFromSheets() {
  // Sheet GIDs: –ó–∞–≤–¥–∞–Ω–Ω—è=0, –†–æ–±–æ—Ç–∞=1, –§—ñ–Ω–∞–Ω—Å–∏=2, –ù–æ—Ç–∞—Ç–∫–∏=3 (adjust if needed)
  const sheetNames = [
    { name: '–ó–∞–≤–¥–∞–Ω–Ω—è', gid: null },
    { name: '–§—ñ–Ω–∞–Ω—Å–∏', gid: null },
    { name: '–ù–æ—Ç–∞—Ç–∫–∏', gid: null },
  ];
  try {
    const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    for(const s of sheetNames) {
      const url = `${base}&sheet=${encodeURIComponent(s.name)}`;
      const resp = await fetch(url);
      if(!resp.ok) continue;
      const text = await resp.text();
      // Strip google's JS wrapper
      const json = JSON.parse(text.replace(/^[^(]*\(|\);?$/g, ''));
      const rows = json.table?.rows || [];
      if(s.name === '–ó–∞–≤–¥–∞–Ω–Ω—è') {
        const sheetTaskIds = new Set(tasks.map(t => t.sheet_id));
        rows.forEach((row, i) => {
          const cells = row.c || [];
          const dateRaw = cells[0]?.v || '';
          const text2 = cells[1]?.f || cells[1]?.v || '';
          const status = cells[2]?.v || '–ê–∫—Ç–∏–≤–Ω–µ';
          if(!text2) return;
          const sheetId = `sheet_task_${i}`;
          if(deletedSheetIds.has(sheetId)) return; // user deleted this ‚Äî never import again
          if(sheetTaskIds.has(sheetId)) return; // already imported
          if(tasks.find(t => t.text === text2)) return;
          tasks.push({
            id: Date.now() + Math.random(),
            sheet_id: sheetId,
            text: text2,
            date: '',
            priority: 'MID',
            done: status === '–í–∏–∫–æ–Ω–∞–Ω–æ',
            from_bot: true,
          });
        });
      } else if(s.name === '–§—ñ–Ω–∞–Ω—Å–∏') {
        const sheetTxnIds = new Set(transactions.map(t => t.sheet_id));
        rows.forEach((row, i) => {
          const cells = row.c || [];
          const text2 = cells[1]?.v || '';
          const amount = parseFloat(cells[2]?.v) || 0;
          const currency = cells[3]?.v || 'UAH';
          const type2 = cells[4]?.v || '–í–∏—Ç—Ä–∞—Ç–∞';
          if(!text2 && !amount) return;
          const sheetId = `sheet_txn_${i}`;
          if(deletedSheetIds.has(sheetId)) return; // user deleted ‚Äî skip
          if(sheetTxnIds.has(sheetId)) return;
          const sym = { UAH:'‚Ç¥', USD:'$', USDT:'‚ÇÆ', EUR:'‚Ç¨' }[currency] || '‚Ç¥';
          transactions.unshift({
            id: Date.now() + Math.random(),
            sheet_id: sheetId,
            type: type2, amount, currency, sym,
            desc: text2 || type2,
            date: cells[0]?.v || '',
            from_bot: true,
          });
        });
      } else if(s.name === '–ù–æ—Ç–∞—Ç–∫–∏') {
        const sheetNoteIds = new Set(notes.map(n => n.sheet_id));
        rows.forEach((row, i) => {
          const cells = row.c || [];
          const text2 = cells[2]?.v || '';
          if(!text2) return;
          const sheetId = `sheet_note_${i}`;
          if(deletedSheetIds.has(sheetId)) return; // user deleted ‚Äî skip
          if(sheetNoteIds.has(sheetId)) return;
          if(notes.find(n => n.text === text2)) return;
          notes.unshift({
            id: Date.now() + Math.random(),
            sheet_id: sheetId,
            title: '–ó –±–æ—Ç–∞',
            text: text2,
            date: cells[0]?.v || '',
            from_bot: true,
          });
        });
      }
    }
    saveDB();
  } catch(e) {
    console.warn('Sheets sync error:', e);
  }
}

function loadDB(callback) {
  if(tgCloud) {
    tgCloud.getItem('urban_v2', (err, value) => {
      if(!err && value) {
        try { applyDB(JSON.parse(value)); } catch(e) {}
      } else {
        loadFromLocal();
      }
      // Always sync from Sheets after loading local data
      syncFromSheets().then(() => callback());
    });
  } else {
    loadFromLocal();
    syncFromSheets().then(() => callback());
  }
}

function loadFromLocal() {
  try {
    const raw = localStorage.getItem('urban_v2');
    if(raw) applyDB(JSON.parse(raw));
  } catch(e) { console.warn('Load error', e); }
}

function applyDB(db) {
  tasks        = db.tasks        || [];
  notes        = db.notes        || [];
  jobs         = db.jobs         || [];
  investments  = db.investments  || [];
  transactions = db.transactions || [];
  events       = db.events       || [];
  deletedSheetIds = new Set(db.deletedSheetIds || []);
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Data
let tasks = [];
let notes = [];
let jobs = [];
let investments = [];
let transactions = [];
let events = [];

// Calendar state
let calYear, calMonth, selectedDate;

const CURRENCY_SYMBOLS = { UAH: '‚Ç¥', USD: '$', USDT: '‚ÇÆ', EUR: '‚Ç¨' };
const MONTHS_UK = ['–°—ñ—á–µ–Ω—å','–õ—é—Ç–∏–π','–ë–µ—Ä–µ–∑–µ–Ω—å','–ö–≤—ñ—Ç–µ–Ω—å','–¢—Ä–∞–≤–µ–Ω—å','–ß–µ—Ä–≤–µ–Ω—å','–õ–∏–ø–µ–Ω—å','–°–µ—Ä–ø–µ–Ω—å','–í–µ—Ä–µ—Å–µ–Ω—å','–ñ–æ–≤—Ç–µ–Ω—å','–õ–∏—Å—Ç–æ–ø–∞–¥','–ì—Ä—É–¥–µ–Ω—å'];
const DAYS_UK = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–ù–¥'];

// Init date
function initDate() {
  const now = new Date();
  const days = ['–ù–µ–¥—ñ–ª—è','–ü–æ–Ω–µ–¥—ñ–ª–æ–∫','–í—ñ–≤—Ç–æ—Ä–æ–∫','–°–µ—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä','–ü—è—Ç–Ω–∏—Ü—è','–°—É–±–æ—Ç–∞'];
  const months = ['–°—ñ—á','–õ—é—Ç','–ë–µ—Ä','–ö–≤—ñ','–¢—Ä–∞','–ß–µ—Ä','–õ–∏–ø','–°–µ—Ä','–í–µ—Ä','–ñ–æ–≤','–õ–∏—Å','–ì—Ä—É'];
  document.getElementById('header-date').innerHTML = `${days[now.getDay()]}<br>${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;

  calYear = now.getFullYear();
  calMonth = now.getMonth();
  selectedDate = now.toISOString().split('T')[0];

  // Set default dates in inputs
  const dateStr = now.toISOString().split('T')[0];
  document.getElementById('event-date-input').value = dateStr;
  document.getElementById('task-date-input').value = dateStr;

  renderCalendar();
}

// Tab switching
const ALL_TABS = ['dashboard','work','planner','tasks','finance','notes'];
function showTab(name) {
  ALL_TABS.forEach(t => {
    const el = document.getElementById('tab-'+t);
    if(el) el.style.display = t===name ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.toggle('active', btn.onclick?.toString().includes(`'${name}'`));
  });
  currentTab = name;
}
function switchBottom(el, name) {
  document.querySelectorAll('.bot-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  showTab(name);
}
function showFinSub(name) {
  document.getElementById('fin-overview').style.display = name==='overview' ? 'block' : 'none';
  document.getElementById('fin-invest').style.display = name==='invest' ? 'block' : 'none';
  document.getElementById('fst-overview').classList.toggle('active', name==='overview');
  document.getElementById('fst-invest').classList.toggle('active', name==='invest');
}

// FAB
function fabAction() {
  const actions = {
    dashboard: () => openModal('modal-add-task'),
    work: () => openModal('modal-add-job'),
    planner: () => openModal('modal-add-event'),
    tasks: () => openModal('modal-add-task'),
    finance: () => openFinModal('–î–æ—Ö—ñ–¥'),
    notes: () => openModal('modal-add-note'),
  };
  (actions[currentTab] || actions.dashboard)();
}

// Modal
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
function closeOnBg(e, id) {
  if(e.target === document.getElementById(id)) closeModal(id);
}

// Finance modal
function openFinModal(type) {
  selectedFinType = type;
  const icons = {–î–æ—Ö—ñ–¥:'‚ûï',–í–∏—Ç—Ä–∞—Ç–∞:'‚ûñ',–Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è:'üìà'};
  document.getElementById('fin-modal-title').textContent = `${icons[type]||'üí∞'} ${type}`;
  document.getElementById('fin-amount-input').value = '';
  document.getElementById('fin-desc-input').value = '';
  selectedFinCurrency = 'UAH';
  document.querySelectorAll('#fin-currency-pick .cur-btn').forEach((b,i) => b.classList.toggle('active', i===0));
  openModal('modal-add-finance');
}
function selectFinCur(el, cur) {
  selectedFinCurrency = cur;
  document.querySelectorAll('#fin-currency-pick .cur-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

// Color pickers
function selectColor(el, color) {
  selectedColor = color;
  document.querySelectorAll('#color-pick .color-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
}
function selectColorInv(el, color) {
  selectedColorInv = color;
  document.querySelectorAll('#color-pick-inv .color-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
}
function selectCur(el, cur) {
  selectedCurrency = cur;
  document.querySelectorAll('#currency-pick .cur-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}
function selectPri(p) {
  selectedPriority = p;
  document.querySelectorAll('.pri-btn').forEach(b => { b.className = 'pri-btn'; });
  document.getElementById('pri-'+p.toLowerCase()).className = `pri-btn active-${p.toLowerCase()}`;
}

// --- TASKS ---
let selectedRecurring = 'none';
function selectRecurring(type) {
  selectedRecurring = type;
  ['none','daily','custom'].forEach(r => {
    const el = document.getElementById('rec-'+r);
    if(el) el.className = 'pri-btn' + (r===type ? ' active-low' : '');
  });
  document.getElementById('recurring-days-wrap').style.display = type==='custom' ? 'block' : 'none';
}

function autoResetRecurringTasks() {
  const today = new Date().toISOString().split('T')[0];
  let changed = false;
  tasks = tasks.filter(t => {
    if(!t.recurring) return true;
    // Check if recurring period is over ‚Äî remove expired tasks
    const start = new Date(t.recurring_start);
    const end = new Date(t.recurring_start);
    end.setDate(end.getDate() + (t.recurring_days || 365));
    const todayDate = new Date(today);
    if(todayDate > end) return false; // Remove expired
    return true;
  });
  tasks.forEach(t => {
    if(!t.recurring) return;
    if(t.last_reset !== today) {
      t.done = false;
      t.date = today;
      t.last_reset = today;
      changed = true;
    }
  });
  if(changed) saveDB();
}

function saveTask() {
  const text = document.getElementById('task-text-input').value.trim();
  if(!text) { alert('–í–≤–µ–¥–∏ –∑–∞–≤–¥–∞–Ω–Ω—è!'); return; }
  const date = document.getElementById('task-date-input').value;
  const today = new Date().toISOString().split('T')[0];

  if(selectedRecurring === 'daily' || selectedRecurring === 'custom') {
    const days = selectedRecurring === 'daily' ? 365 :
      (parseInt(document.getElementById('recurring-days-input').value) || 30);
    tasks.push({
      id: Date.now(),
      text,
      date: date || today,
      priority: selectedPriority,
      done: false,
      recurring: 'daily',
      recurring_days: days,
      recurring_start: date || today,
      last_reset: today,
    });
  } else {
    tasks.push({ id: Date.now(), text, date, priority: selectedPriority, done: false });
  }

  saveDB(); renderTasks(); updateDashboard();
  closeModal('modal-add-task');
  document.getElementById('task-text-input').value = '';
  document.getElementById('task-date-input').value = new Date().toISOString().split('T')[0];
  selectedRecurring = 'none';
  selectRecurring('none');
}

function renderTasks() {
  const list = document.getElementById('tasks-list');
  // Show today's tasks first, then future, then done
  const today = new Date().toISOString().split('T')[0];
  const sorted = [...tasks].sort((a,b) => {
    if(a.done !== b.done) return a.done ? 1 : -1;
    const da = a.date || '9999';
    const db2 = b.date || '9999';
    return da.localeCompare(db2);
  });
  if(!sorted.length) {
    list.innerHTML = '<div class="empty-state"><div class="ei">‚úÖ</div><div class="et">–ó–∞–≤–¥–∞–Ω—å –Ω–µ–º–∞—î</div><div class="es">–ù–∞—Ç–∏—Å–Ω–∏ "+ –î–æ–¥–∞—Ç–∏" —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</div></div>';
    return;
  }
  list.innerHTML = sorted.map(t => {
    const isToday = t.date === today;
    const isOverdue = t.date && t.date < today && !t.done;
    const recBadge = t.recurring ? `<span style="font-size:0.6rem;color:var(--accent);font-family:'JetBrains Mono'">üîÅ</span>` : '';
    const dateLabel = t.date ? (isToday ? 'üìÖ –°—å–æ–≥–æ–¥–Ω—ñ' : isOverdue ? `‚ö†Ô∏è ${t.date}` : t.date) : '–ë–µ–∑ –¥–∞—Ç–∏';
    const dateColor = isOverdue ? 'color:var(--red)' : isToday ? 'color:var(--green)' : '';
    return `
    <div class="swipe-item" id="task-sw-${t.id}">
      <div class="swipe-delete-bg">üóëÔ∏è</div>
      <div class="swipe-inner task-item" style="border-radius:14px">
        <div class="task-check ${t.done?'done':''}" onclick="toggleTask(${t.id})">${t.done?'‚úì':''}</div>
        <div class="task-info">
          <div class="task-text ${t.done?'done':''}">${t.text} ${recBadge}</div>
          <div class="task-date" style="${dateColor}">${dateLabel}</div>
        </div>
        <div class="task-priority ${t.priority.toLowerCase()}">${t.priority}</div>
      </div>
    </div>`;
  }).join('');
  sorted.forEach(t => initSwipe(`task-sw-${t.id}`, () => askDelete('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è?', () => deleteTask(t.id))));
}

function toggleTask(id) {
  const t = tasks.find(t => t.id===id);
  if(t) { t.done = !t.done; saveDB(); renderTasks(); updateDashboard(); }
}
function deleteTask(id) {
  const t = tasks.find(t => t.id === id);
  if(t?.sheet_id) deletedSheetIds.add(t.sheet_id);
  tasks = tasks.filter(t => t.id!==id);
  saveDB(); renderTasks(); updateDashboard();
}

// --- NOTES ---
function saveNote() {
  const title = document.getElementById('note-title-input').value.trim();
  const text = document.getElementById('note-text-input').value.trim();
  if(!title && !text) { alert('–í–≤–µ–¥–∏ –Ω–æ—Ç–∞—Ç–∫—É!'); return; }
  const now = new Date();
  const dateStr = `${now.getDate()} ${MONTHS_UK[now.getMonth()].slice(0,3)} ¬∑ ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
  notes.unshift({ id: Date.now(), title: title||'–ù–æ—Ç–∞—Ç–∫–∞', text, date: dateStr });
  saveDB();
  renderNotes();
  closeModal('modal-add-note');
  document.getElementById('note-title-input').value = '';
  document.getElementById('note-text-input').value = '';
}

function renderNotes() {
  const list = document.getElementById('notes-list');
  if(!notes.length) {
    list.innerHTML = '<div class="empty-state"><div class="ei">üìù</div><div class="et">–ù–æ—Ç–∞—Ç–æ–∫ –Ω–µ–º–∞—î</div><div class="es">–°–≤–∞–π–ø –≤–ª—ñ–≤–æ —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É</div></div>';
    return;
  }
  list.innerHTML = notes.map(n => `
    <div class="swipe-item" id="note-sw-${n.id}" style="margin-bottom:8px">
      <div class="swipe-delete-bg">üóëÔ∏è</div>
      <div class="swipe-inner note-card">
        <div class="note-card-title">${n.title}</div>
        <div class="note-card-date">${n.date}</div>
        <div class="note-card-text">${n.text}</div>
      </div>
    </div>`).join('');
  notes.forEach(n => initSwipe(`note-sw-${n.id}`, () => askDelete('–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –Ω–æ—Ç–∞—Ç–∫—É?', () => deleteNote(n.id))));
}

function deleteNote(id) {
  const n = notes.find(n => n.id === id);
  if(n?.sheet_id) deletedSheetIds.add(n.sheet_id);
  notes = notes.filter(n => n.id!==id);
  saveDB(); renderNotes();
}

// --- CHARTS ---
function updateFinanceChart() {
  const income = transactions.filter(t=>t.type==='–î–æ—Ö—ñ–¥'&&t.currency==='UAH').reduce((s,t)=>s+t.amount,0);
  const expense = transactions.filter(t=>t.type==='–í–∏—Ç—Ä–∞—Ç–∞'&&t.currency==='UAH').reduce((s,t)=>s+t.amount,0);
  const total = income + expense;

  document.getElementById('fin-chart-income').textContent = `‚Ç¥${income.toLocaleString()}`;
  document.getElementById('fin-chart-expense').textContent = `‚Ç¥${expense.toLocaleString()}`;

  const C = 2 * Math.PI * 40; // circumference
  if(total === 0) {
    document.getElementById('fin-donut-income').setAttribute('stroke-dasharray', `0 ${C}`);
    document.getElementById('fin-donut-expense').setAttribute('stroke-dasharray', `0 ${C}`);
    document.getElementById('fin-donut-pct').textContent = '‚Äî';
    return;
  }
  const incomeArc = (income / total) * C;
  const expenseArc = (expense / total) * C;
  // Income arc starts at top
  document.getElementById('fin-donut-income').setAttribute('stroke-dasharray', `${incomeArc} ${C - incomeArc}`);
  document.getElementById('fin-donut-income').setAttribute('stroke-dashoffset', '0');
  // Expense arc starts after income
  document.getElementById('fin-donut-expense').setAttribute('stroke-dasharray', `${expenseArc} ${C - expenseArc}`);
  document.getElementById('fin-donut-expense').setAttribute('stroke-dashoffset', `${-incomeArc}`);

  const roi = expense > 0 ? Math.round((income / expense - 1) * 100) : 100;
  document.getElementById('fin-donut-pct').textContent = `${roi > 0 ? '+' : ''}${roi}%`;
  document.getElementById('fin-donut-pct').style.color = roi >= 0 ? 'var(--green)' : 'var(--red)';
}

function updateInvestChart() {
  if(!investments.length) {
    document.getElementById('inv-chart-card').style.display = 'none';
    return;
  }
  document.getElementById('inv-chart-card').style.display = 'block';
  const total = investments.reduce((s,i) => s + i.amount, 0);
  const svg = document.getElementById('inv-donut');
  const cx = 55, cy = 55, r = 40;
  const C = 2 * Math.PI * r;

  let html = '';
  let legendHtml = '';
  let offset = 0;

  investments.forEach((inv, idx) => {
    const pct = total > 0 ? inv.amount / total : 1 / investments.length;
    const arc = pct * C;
    // Convert to SVG dasharray with rotation
    const rotation = (offset / C) * 360 - 90;
    html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${inv.color}" stroke-width="14"
      stroke-dasharray="${arc} ${C - arc}" stroke-linecap="round"
      transform="rotate(${rotation} ${cx} ${cy})" style="transition:stroke-dasharray 0.6s ease"/>`;

    legendHtml += `
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
        <div style="width:8px;height:8px;border-radius:50%;background:${inv.color};flex-shrink:0"></div>
        <div style="flex:1;font-size:0.68rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${inv.name}</div>
        <div style="font-size:0.65rem;font-family:'JetBrains Mono';color:var(--muted)">${Math.round(pct*100)}%</div>
      </div>`;
    offset += arc;
  });

  svg.innerHTML = `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--border)" stroke-width="14"/>` + html;
  document.getElementById('inv-legend').innerHTML = legendHtml;
  document.getElementById('inv-donut-center').innerHTML = `${investments.length}<br><span style="font-size:0.5rem;color:var(--muted)">–∞–∫—Ç–∏–≤—ñ–≤</span>`;
}

// --- FINANCE ---
function saveFinance() {
  const amount = document.getElementById('fin-amount-input').value.trim();
  const desc = document.getElementById('fin-desc-input').value.trim();
  if(!amount) { alert('–í–≤–µ–¥–∏ —Å—É–º—É!'); return; }
  const sym = CURRENCY_SYMBOLS[selectedFinCurrency];
  const now = new Date();
  const dateStr = `${now.getDate()} ${MONTHS_UK[now.getMonth()].slice(0,3)} ¬∑ ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
  const txn = { id: Date.now(), type: selectedFinType, amount: parseFloat(amount), currency: selectedFinCurrency, sym, desc: desc||selectedFinType, date: dateStr };
  transactions.unshift(txn);
  saveDB();
  renderTransactions();
  updateFinanceTotals();
  updateDashboard();
  closeModal('modal-add-finance');
}

function renderTransactions() {
  const list = document.getElementById('txn-list');
  if(!transactions.length) {
    list.innerHTML = '<div class="empty-state"><div class="ei">üí≥</div><div class="et">–û–ø–µ—Ä–∞—Ü—ñ–π –Ω–µ–º–∞—î</div><div class="es">–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–∫—É –≤–∏—â–µ —â–æ–± –¥–æ–¥–∞—Ç–∏</div></div>';
    return;
  }
  const icons = { –î–æ—Ö—ñ–¥:'üíº', –í–∏—Ç—Ä–∞—Ç–∞:'üõí', –Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è:'üìà' };
  const colors = { –î–æ—Ö—ñ–¥:'var(--green)', –í–∏—Ç—Ä–∞—Ç–∞:'var(--red)', –Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è:'var(--accent)' };
  const signs = { –î–æ—Ö—ñ–¥:'+', –í–∏—Ç—Ä–∞—Ç–∞:'-', –Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è:'+' };
  list.innerHTML = transactions.slice(0,10).map(t => `
    <div class="swipe-item" id="txn-sw-${t.id}" style="margin-bottom:8px">
      <div class="swipe-delete-bg">üóëÔ∏è</div>
      <div class="swipe-inner txn-item">
        <div class="txn-ico" style="background:rgba(255,255,255,0.05)">${icons[t.type]||'üí∞'}</div>
        <div class="txn-info"><div class="txn-name">${t.desc}</div><div class="txn-date">${t.date} ¬∑ ${t.currency}</div></div>
        <div class="txn-amt" style="color:${colors[t.type]}">${signs[t.type]}${t.sym}${t.amount.toLocaleString()}</div>
      </div>
    </div>`).join('');
  transactions.forEach(t => initSwipe(`txn-sw-${t.id}`, () => askDelete('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –æ–ø–µ—Ä–∞—Ü—ñ—é?', () => deleteTxn(t.id))));
}

function deleteTxn(id) {
  const t = transactions.find(t => t.id === id);
  if(t?.sheet_id) deletedSheetIds.add(t.sheet_id);
  transactions = transactions.filter(t => t.id!==id);
  saveDB(); renderTransactions(); updateFinanceTotals(); updateDashboard();
}

function updateFinanceTotals() {
  const income = transactions.filter(t=>t.type==='–î–æ—Ö—ñ–¥'&&t.currency==='UAH').reduce((s,t)=>s+t.amount,0);
  const expense = transactions.filter(t=>t.type==='–í–∏—Ç—Ä–∞—Ç–∞'&&t.currency==='UAH').reduce((s,t)=>s+t.amount,0);
  const investUSD = investments.reduce((s,i)=>i.currency==='USD'||i.currency==='USDT'?s+i.amount:s,0);
  const workIncome = jobs.reduce((s,j)=>s+j.income,0);
  document.getElementById('fin-income-total').textContent = `‚Ç¥${income.toLocaleString()}`;
  document.getElementById('fin-expense-total').textContent = `‚Ç¥${expense.toLocaleString()}`;
  document.getElementById('fin-invest-total').textContent = `$${investUSD.toLocaleString()}`;
  document.getElementById('fin-work-total').textContent = `‚Ç¥${workIncome.toLocaleString()}`;
  updateFinanceChart();
}

// --- JOBS ---
function saveJob() {
  const name = document.getElementById('job-name-input').value.trim();
  const income = parseFloat(document.getElementById('job-income-input').value)||0;
  if(!name) { alert('–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É!'); return; }
  jobs.push({ id: Date.now(), name, income, color: selectedColor, notes: [] });
  saveDB();
  renderJobs();
  updateDashboard();
  closeModal('modal-add-job');
  document.getElementById('job-name-input').value = '';
  document.getElementById('job-income-input').value = '';
}

function renderJobs() {
  const list = document.getElementById('jobs-list');
  const total = jobs.reduce((s,j)=>s+j.income,0);
  document.getElementById('work-total').textContent = `‚Ç¥${total.toLocaleString()}`;
  document.getElementById('work-count2').textContent = jobs.length;
  document.getElementById('jobs-count').textContent = `${jobs.length} –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤`;
  if(!jobs.length) {
    list.innerHTML = '<div class="empty-state"><div class="ei">üíº</div><div class="et">–ù–µ–º–∞—î –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤</div><div class="es">–î–æ–¥–∞–π –ø–µ—Ä—à—É —Ä–æ–±–æ—Ç—É –∞–±–æ –ø—Ä–æ–µ–∫—Ç</div></div>';
    return;
  }
  list.innerHTML = jobs.map(j => `
    <div class="job-card">
      <div class="job-header" onclick="toggleJob(this)">
        <div class="job-color" style="background:${j.color}"></div>
        <div class="job-name">${j.name}</div>
        <div class="job-income">‚Ç¥${j.income.toLocaleString()}</div>
        <div class="job-arrow">‚ñ∂</div>
      </div>
      <div class="job-body">
        <div class="job-stats">
          <div class="jstat"><div class="jstat-val" style="color:var(--green)">‚Ç¥${j.income.toLocaleString()}</div><div class="jstat-label">–î–æ—Ö—ñ–¥</div></div>
          <div class="jstat"><div class="jstat-val" style="color:var(--red)">‚Ç¥${(j.expense||0).toLocaleString()}</div><div class="jstat-label">–í–∏—Ç—Ä–∞—Ç–∏</div></div>
          <div class="jstat"><div class="jstat-val" style="color:var(--accent)">‚Ç¥${(j.income-(j.expense||0)).toLocaleString()}</div><div class="jstat-label">–ß–∏—Å—Ç–∏–π</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
          <button class="modal-btn" style="margin:0;padding:10px;font-size:0.75rem;background:linear-gradient(135deg,var(--green),#059669)" onclick="addJobIncome(${j.id})">‚ûï –î–æ—Ö—ñ–¥</button>
          <button class="modal-btn" style="margin:0;padding:10px;font-size:0.75rem;background:linear-gradient(135deg,var(--red),#dc2626)" onclick="addJobExpense(${j.id})">‚ûñ –í–∏—Ç—Ä–∞—Ç–∞</button>
        </div>
        <div class="job-notes-title">–ë–ª–æ–∫–Ω–æ—Ç</div>
        <div id="job-notes-${j.id}">
          ${(j.notes||[]).map((n,ni) => `
            <div class="job-note" style="justify-content:space-between;align-items:flex-start">
              <div style="display:flex;gap:8px;flex:1">
                <div class="note-dot" style="background:${j.color};margin-top:5px"></div>
                <div id="jn-text-${j.id}-${ni}" style="flex:1;font-size:0.75rem;line-height:1.5">${n.text}</div>
              </div>
              <div style="display:flex;gap:6px;margin-left:8px;flex-shrink:0">
                <button onclick="editJobNote(${j.id},${ni})" style="background:rgba(59,130,246,0.15);border:none;border-radius:6px;color:var(--accent);padding:3px 7px;font-size:0.65rem;cursor:pointer">‚úèÔ∏è</button>
                <button onclick="deleteJobNote(${j.id},${ni})" style="background:rgba(239,68,68,0.15);border:none;border-radius:6px;color:var(--red);padding:3px 7px;font-size:0.65rem;cursor:pointer">üóëÔ∏è</button>
              </div>
            </div>`).join('')}
        </div>
        <button class="add-note-btn" onclick="addJobNote(this,${j.id})">+ –î–æ–¥–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É</button>
      </div>
    </div>`).join('');
  updateFinanceTotals();
}

function toggleJob(header) {
  const body = header.nextElementSibling;
  const arrow = header.querySelector('.job-arrow');
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  header.classList.toggle('open', !isOpen);
  arrow.classList.toggle('open', !isOpen);
}

let _jobNoteTarget = null;
function addJobNote(btn, jobId) {
  _jobNoteTarget = { btn, jobId, noteIndex: -1 };
  document.getElementById('job-note-input').value = '';
  document.getElementById('job-note-modal-title').textContent = 'üìã –ù–æ–≤–∞ –Ω–æ—Ç–∞—Ç–∫–∞';
  openModal('modal-job-note');
  setTimeout(() => document.getElementById('job-note-input').focus(), 300);
}
function editJobNote(jobId, noteIndex) {
  const job = jobs.find(j=>j.id===jobId);
  if(!job || !job.notes[noteIndex]) return;
  _jobNoteTarget = { btn: null, jobId, noteIndex };
  document.getElementById('job-note-input').value = job.notes[noteIndex].text;
  document.getElementById('job-note-modal-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É';
  openModal('modal-job-note');
  setTimeout(() => document.getElementById('job-note-input').focus(), 300);
}
function deleteJobNote(jobId, noteIndex) {
  askDelete('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –Ω–æ—Ç–∞—Ç–∫—É –∑ –ø—Ä–æ–µ–∫—Ç—É?', () => {
    const job = jobs.find(j=>j.id===jobId);
    if(!job) return;
    job.notes.splice(noteIndex, 1);
    saveDB(); renderJobs();
  });
}
function saveJobNote() {
  const text = document.getElementById('job-note-input').value.trim();
  if(!text) return;
  const { jobId, noteIndex } = _jobNoteTarget;
  const job = jobs.find(j=>j.id===jobId);
  if(!job) return;
  if(!job.notes) job.notes = [];
  const today = new Date().toLocaleDateString('uk-UA',{day:'numeric',month:'short'});
  if(noteIndex >= 0) {
    job.notes[noteIndex].text = text;
  } else {
    job.notes.push({ text, date: today });
  }
  saveDB(); renderJobs();
  closeModal('modal-job-note');
  _jobNoteTarget = null;
}

// Job income/expense
let _jobFinTarget = null;
function addJobIncome(jobId) {
  _jobFinTarget = { jobId, type: 'income' };
  document.getElementById('job-fin-title').textContent = '‚ûï –î–æ—Ö—ñ–¥ –ø–æ –ø—Ä–æ–µ–∫—Ç—É';
  document.getElementById('job-fin-input').value = '';
  openModal('modal-job-fin');
  setTimeout(() => document.getElementById('job-fin-input').focus(), 300);
}
function addJobExpense(jobId) {
  _jobFinTarget = { jobId, type: 'expense' };
  document.getElementById('job-fin-title').textContent = '‚ûñ –í–∏—Ç—Ä–∞—Ç–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç—É';
  document.getElementById('job-fin-input').value = '';
  openModal('modal-job-fin');
  setTimeout(() => document.getElementById('job-fin-input').focus(), 300);
}
function saveJobFin() {
  const amount = parseFloat(document.getElementById('job-fin-input').value)||0;
  if(!amount) return;
  const { jobId, type } = _jobFinTarget;
  const job = jobs.find(j=>j.id===jobId);
  if(!job) return;
  if(type === 'income') {
    job.income = (job.income||0) + amount;
  } else {
    job.expense = (job.expense||0) + amount;
  }
  saveDB(); renderJobs(); updateFinanceTotals(); updateDashboard();
  closeModal('modal-job-fin');
  _jobFinTarget = null;
}

// --- INVESTMENTS ---
function saveInvest() {
  const name = document.getElementById('inv-name-input').value.trim();
  const amount = parseFloat(document.getElementById('inv-amount-input').value)||0;
  if(!name) { alert('–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É!'); return; }
  const sym = CURRENCY_SYMBOLS[selectedCurrency];
  investments.push({ id: Date.now(), name, amount, currency: selectedCurrency, sym, color: selectedColorInv });
  saveDB();
  renderInvestments();
  updateFinanceTotals();
  closeModal('modal-add-invest');
  document.getElementById('inv-name-input').value = '';
  document.getElementById('inv-amount-input').value = '';
}

function renderInvestments() {
  const list = document.getElementById('inv-list');
  const calcCurrent = (i) => {
    const txns = i.txns || [];
    const profit = txns.filter(t=>t.type!=='withdraw').reduce((s,t)=>s+t.amount,0)
                 - txns.filter(t=>t.type==='withdraw').reduce((s,t)=>s+t.amount,0);
    return i.amount + profit;
  };
  const totalUSD = investments.filter(i=>i.currency==='USD'||i.currency==='USDT').reduce((s,i)=>s+calcCurrent(i),0);
  const totalUAH = investments.filter(i=>i.currency==='UAH').reduce((s,i)=>s+calcCurrent(i),0);
  document.getElementById('inv-total').textContent = `$${totalUSD.toLocaleString()}`;
  document.getElementById('inv-total-uah').textContent = `‚Ç¥${totalUAH.toLocaleString()}`;
  document.getElementById('inv-count').textContent = `${investments.length} –∞–∫—Ç–∏–≤—ñ–≤`;
  document.getElementById('inv-count2').textContent = investments.length;
  if(!investments.length) {
    list.innerHTML = '<div class="empty-state"><div class="ei">üìà</div><div class="et">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤—ñ–≤</div><div class="es">–î–æ–¥–∞–π –ø–µ—Ä—à–∏–π —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π–Ω–∏–π –∞–∫—Ç–∏–≤</div></div>';
    updateInvestChart();
    return;
  }
  list.innerHTML = investments.map(i => {
    const txns = (i.txns || []);
    const totalIn = txns.filter(t=>t.type!=='withdraw').reduce((s,t)=>s+t.amount,0);
    const totalOut = txns.filter(t=>t.type==='withdraw').reduce((s,t)=>s+t.amount,0);
    const profit = totalIn - totalOut;
    const current = i.amount + profit;
    const roi = i.amount > 0 ? ((profit / i.amount) * 100).toFixed(1) : 0;
    const roiColor = profit >= 0 ? 'var(--green)' : 'var(--red)';
    const txnHtml = txns.length ? txns.slice(-5).reverse().map(t => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
        <div>
          <div style="font-size:0.72rem;font-weight:600">${t.desc}</div>
          <div style="font-size:0.6rem;color:var(--muted);font-family:'JetBrains Mono'">${t.date}</div>
        </div>
        <div style="font-family:'JetBrains Mono';font-size:0.8rem;font-weight:700;color:${t.type==='withdraw'?'var(--red)':'var(--green)'}">
          ${t.type==='withdraw'?'-':'+'}${i.sym}${t.amount.toLocaleString()}
        </div>
      </div>`).join('') : '<div style="font-size:0.72rem;color:var(--muted);text-align:center;padding:8px 0">–û–ø–µ—Ä–∞—Ü—ñ–π —â–µ –Ω–µ–º–∞—î</div>';

    return `
    <div class="swipe-item" id="inv-sw-${i.id}" style="margin-bottom:8px">
      <div class="swipe-delete-bg">üóëÔ∏è</div>
      <div class="swipe-inner job-card">
        <div class="job-header" onclick="toggleJob(this)">
          <div class="job-color" style="background:${i.color}"></div>
          <div class="job-name">${i.name}</div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
            <div class="job-income" style="color:var(--green)">${i.sym}${current.toLocaleString()}</div>
            <div style="font-size:0.6rem;color:${roiColor};font-family:'JetBrains Mono'">${profit>=0?'+':''}${i.sym}${profit.toFixed(2)} (${roi}%)</div>
          </div>
          <div class="job-arrow">‚ñ∂</div>
        </div>
        <div class="job-body">
          <div class="job-stats">
            <div class="jstat"><div class="jstat-val" style="color:var(--muted)">${i.sym}${i.amount.toLocaleString()}</div><div class="jstat-label">–í–∫–ª–∞–¥–µ–Ω–æ</div></div>
            <div class="jstat"><div class="jstat-val" style="color:var(--green)">${i.sym}${totalIn.toFixed(2)}</div><div class="jstat-label">–î–∏–≤—ñ–¥–µ–Ω–¥–∏</div></div>
            <div class="jstat"><div class="jstat-val" style="color:${roiColor}">${profit>=0?'+':''}${roi}%</div><div class="jstat-label">ROI</div></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:14px">
            <button class="modal-btn" style="margin:0;padding:9px 4px;font-size:0.68rem;background:linear-gradient(135deg,var(--green),#059669)" onclick="addInvTxn(${i.id},'dividend')">üéØ –î–∏–≤—ñ–¥–µ–Ω–¥–∏</button>
            <button class="modal-btn" style="margin:0;padding:9px 4px;font-size:0.68rem;background:linear-gradient(135deg,var(--accent),var(--accent2))" onclick="addInvTxn(${i.id},'deposit')">‚ûï –ü–æ–ø–æ–≤–Ω–∏—Ç–∏</button>
            <button class="modal-btn" style="margin:0;padding:9px 4px;font-size:0.68rem;background:linear-gradient(135deg,var(--red),#dc2626)" onclick="addInvTxn(${i.id},'withdraw')">‚ûñ –í–∏–≤–µ—Å—Ç–∏</button>
          </div>
          <div class="job-notes-title">–Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π</div>
          <div id="inv-txns-${i.id}">${txnHtml}</div>
        </div>
      </div>
    </div>`;
  }).join('');
  investments.forEach(i => initSwipe(`inv-sw-${i.id}`, () => askDelete('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∞–∫—Ç–∏–≤?', () => deleteInvest(i.id))));
  updateInvestChart();
}

function deleteInvest(id) {
  investments = investments.filter(i=>i.id!==id);
  saveDB(); renderInvestments(); updateFinanceTotals();
}

let _invTxnTarget = null;
const INV_TXN_LABELS = {
  dividend: { title: 'üéØ –î–æ–¥–∞—Ç–∏ –¥–∏–≤—ñ–¥–µ–Ω–¥–∏', btn: 'üí∞ –ó–∞–ø–∏—Å–∞—Ç–∏ –¥–∏–≤—ñ–¥–µ–Ω–¥–∏' },
  deposit:  { title: '‚ûï –ü–æ–ø–æ–≤–Ω–∏—Ç–∏ –∞–∫—Ç–∏–≤',  btn: '‚ûï –ü–æ–ø–æ–≤–Ω–∏—Ç–∏' },
  withdraw: { title: '‚ûñ –í–∏–≤–µ—Å—Ç–∏ –∫–æ—à—Ç–∏',    btn: '‚ûñ –í–∏–≤–µ—Å—Ç–∏' },
};

function addInvTxn(invId, type) {
  _invTxnTarget = { invId, type };
  const labels = INV_TXN_LABELS[type];
  document.getElementById('inv-txn-modal-title').textContent = labels.title;
  document.getElementById('inv-txn-modal-btn').textContent = labels.btn;
  document.getElementById('inv-txn-amount').value = '';
  document.getElementById('inv-txn-desc').value = '';
  // Set default desc
  const defaults = { dividend: '–î–∏–≤—ñ–¥–µ–Ω–¥–∏', deposit: '–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è', withdraw: '–í–∏–≤–µ–¥–µ–Ω–Ω—è' };
  document.getElementById('inv-txn-desc').placeholder = defaults[type];
  openModal('modal-inv-txn');
  setTimeout(() => document.getElementById('inv-txn-amount').focus(), 300);
}

function saveInvTxn() {
  const amount = parseFloat(document.getElementById('inv-txn-amount').value) || 0;
  if(!amount) { alert('–í–≤–µ–¥–∏ —Å—É–º—É!'); return; }
  const desc = document.getElementById('inv-txn-desc').value.trim() ||
    { dividend:'–î–∏–≤—ñ–¥–µ–Ω–¥–∏', deposit:'–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è', withdraw:'–í–∏–≤–µ–¥–µ–Ω–Ω—è' }[_invTxnTarget.type];
  const { invId, type } = _invTxnTarget;
  const inv = investments.find(i => i.id === invId);
  if(!inv) return;
  if(!inv.txns) inv.txns = [];
  const today = new Date().toLocaleDateString('uk-UA', {day:'numeric', month:'short', year:'numeric'});
  inv.txns.push({ type, amount, desc, date: today, id: Date.now() });
  saveDB();
  renderInvestments();
  updateFinanceTotals();
  closeModal('modal-inv-txn');
  _invTxnTarget = null;
}

// --- CALENDAR ---
function renderCalendar() {
  const now = new Date();
  const firstDay = new Date(calYear, calMonth, 1);
  const lastDay = new Date(calYear, calMonth+1, 0);
  let startDow = firstDay.getDay(); // 0=Sun
  // Convert to Mon-based: Mon=0
  startDow = (startDow + 6) % 7;

  document.getElementById('cal-month-title').textContent = `${MONTHS_UK[calMonth]} ${calYear}`;

  const todayStr = now.toISOString().split('T')[0];
  const eventDates = new Set(events.map(e => e.date));

  let html = '';
  // Previous month days
  const prevLastDay = new Date(calYear, calMonth, 0).getDate();
  for(let i = startDow-1; i >= 0; i--) {
    html += `<div class="cal-day other-month">${prevLastDay-i}</div>`;
  }
  // Current month
  for(let d = 1; d <= lastDay.getDate(); d++) {
    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === selectedDate;
    const hasEvent = eventDates.has(dateStr);
    const cls = [isToday?'today':'', isSelected&&!isToday?'selected':'', hasEvent?'has-event':''].filter(Boolean).join(' ');
    html += `<div class="cal-day ${cls}" onclick="selectCalDay('${dateStr}')">${d}</div>`;
  }
  // Next month days
  const totalCells = startDow + lastDay.getDate();
  const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for(let d = 1; d <= remaining; d++) {
    html += `<div class="cal-day other-month">${d}</div>`;
  }
  document.getElementById('cal-days').innerHTML = html;
  renderEvents();
}

function changeMonth(dir) {
  calMonth += dir;
  if(calMonth > 11) { calMonth = 0; calYear++; }
  if(calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar();
}

function selectCalDay(dateStr) {
  selectedDate = dateStr;
  document.getElementById('event-date-input').value = dateStr;
  renderCalendar();
}

function renderEvents() {
  const list = document.getElementById('events-list');
  const dayEvents = events.filter(e => e.date === selectedDate).sort((a,b) => a.time.localeCompare(b.time));
  const d = new Date(selectedDate);
  document.getElementById('cal-events-title').textContent = `–ü–æ–¥—ñ—ó ¬∑ ${d.getDate()} ${MONTHS_UK[d.getMonth()]}`;
  if(!dayEvents.length) {
    list.innerHTML = '<div class="empty-state"><div class="ei">üìÖ</div><div class="et">–ù–µ–º–∞—î –ø–æ–¥—ñ–π</div><div class="es">–ù–∞—Ç–∏—Å–Ω–∏ "+ –î–æ–¥–∞—Ç–∏" —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–¥—ñ—é</div></div>';
    return;
  }
  list.innerHTML = dayEvents.map(e => `
    <div class="swipe-item" id="ev-sw-${e.id}" style="margin-bottom:8px">
      <div class="swipe-delete-bg">üóëÔ∏è</div>
      <div class="swipe-inner event-item">
        <div class="event-time">${e.time||'‚Äî'}</div>
        <div class="event-dot" style="background:var(--accent)"></div>
        <div class="event-info">
          <div class="event-name">${e.name}</div>
          ${e.desc?`<div class="event-meta">${e.desc}</div>`:''}
        </div>
      </div>
    </div>`).join('');
  dayEvents.forEach(e => initSwipe(`ev-sw-${e.id}`, () => askDelete('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–æ–¥—ñ—é?', () => deleteEvent(e.id))));
}

function saveEvent() {
  const name = document.getElementById('event-name-input').value.trim();
  if(!name) { alert('–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É –ø–æ–¥—ñ—ó!'); return; }
  const time = document.getElementById('event-time-input').value;
  const date = document.getElementById('event-date-input').value || selectedDate;
  const desc = document.getElementById('event-desc-input').value.trim();
  events.push({ id: Date.now(), name, time, date, desc });
  saveDB();
  renderCalendar();
  closeModal('modal-add-event');
  document.getElementById('event-name-input').value = '';
  document.getElementById('event-time-input').value = '';
  document.getElementById('event-desc-input').value = '';
}

function deleteEvent(id) {
  events = events.filter(e => e.id!==id);
  saveDB(); renderCalendar();
}

// --- DASHBOARD ---
function updateDashboard() {
  const income = transactions.filter(t=>t.type==='–î–æ—Ö—ñ–¥'&&t.currency==='UAH').reduce((s,t)=>s+t.amount,0);
  const expense = transactions.filter(t=>t.type==='–í–∏—Ç—Ä–∞—Ç–∞'&&t.currency==='UAH').reduce((s,t)=>s+t.amount,0);
  const investUSD = investments.filter(i=>i.currency==='USD'||i.currency==='USDT').reduce((s,i)=>s+i.amount,0);
  const balance = income - expense;
  document.getElementById('dash-balance').textContent = `‚Ç¥${balance.toLocaleString()}`;
  document.getElementById('dash-income').textContent = `‚Ç¥${income.toLocaleString()}`;
  document.getElementById('dash-expense').textContent = `‚Ç¥${expense.toLocaleString()}`;
  document.getElementById('dash-invest').textContent = `$${investUSD.toLocaleString()}`;

  const today = new Date().toISOString().split('T')[0];
  const todayTasks = tasks.filter(t => !t.date || t.date === today || t.recurring);
  const dashList = document.getElementById('dash-tasks-list');

  if(!todayTasks.length) {
    dashList.innerHTML = '<div class="empty-state"><div class="ei">‚úÖ</div><div class="et">–ó–∞–≤–¥–∞–Ω—å –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ –Ω–µ–º–∞—î</div></div>';
    return;
  }

  const icons = { HIGH:'üî¥', MID:'üü°', LOW:'üü¢' };
  dashList.innerHTML = todayTasks.map(t => {
    let recLabel = '';
    if(t.recurring) {
      const start = new Date(t.recurring_start);
      const end = new Date(t.recurring_start);
      end.setDate(end.getDate() + (t.recurring_days || 365));
      const todayD = new Date(today);
      const daysLeft = Math.max(0, Math.round((end - todayD) / 86400000));
      recLabel = `<span style="font-size:0.58rem;color:var(--accent);font-family:'JetBrains Mono'"> üîÅ —â–µ ${daysLeft}–¥</span>`;
    }
    return `
      <div class="task-item" style="margin-bottom:8px" id="dash-task-${t.id}">
        <div class="task-check ${t.done?'done':''}" onclick="toggleTask(${t.id})">${t.done?'‚úì':''}</div>
        <div class="task-info">
          <div class="task-text ${t.done?'done':''}">${t.text}${recLabel}</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <div class="task-priority ${t.priority?.toLowerCase?.() || 'mid'}">${icons[t.priority]||'üü°'}</div>
          <button onclick="askDelete('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è?',()=>deleteTask(${t.id}))"
            style="background:rgba(248,113,113,0.12);border:1px solid rgba(248,113,113,0.2);border-radius:8px;color:var(--red);padding:5px 8px;font-size:0.72rem;cursor:pointer">üóëÔ∏è</button>
        </div>
      </div>`;
  }).join('');
}

// --- SWIPE TO DELETE ---
function initSwipe(wrapperId, onDelete) {
  const wrap = document.getElementById(wrapperId);
  if(!wrap) return;
  const inner = wrap.querySelector('.swipe-inner');
  if(!inner) return;
  let startX = 0, currentX = 0, swiping = false;
  const THRESHOLD = 70;

  inner.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    swiping = true;
  }, { passive: true });

  inner.addEventListener('touchmove', e => {
    if(!swiping) return;
    currentX = e.touches[0].clientX - startX;
    if(currentX < 0) {
      inner.style.transform = `translateX(${Math.max(currentX, -100)}px)`;
    }
  }, { passive: true });

  inner.addEventListener('touchend', () => {
    if(currentX < -THRESHOLD) {
      inner.style.transform = 'translateX(-80px)';
      onDelete();
    } else {
      inner.style.transform = 'translateX(0)';
    }
    swiping = false; currentX = 0;
  });
}

// --- CONFIRM DELETE ---
function askDelete(text, callback) {
  document.getElementById('confirm-text').textContent = text;
  deleteCallback = callback;
  document.getElementById('confirm-delete').classList.add('open');
}
function closeConfirm() {
  document.getElementById('confirm-delete').classList.remove('open');
  deleteCallback = null;
  // Reset all swipes
  document.querySelectorAll('.swipe-inner').forEach(el => el.style.transform = 'translateX(0)');
}
function confirmDelete() {
  if(deleteCallback) deleteCallback();
  closeConfirm();
}

async function manualSync() {
  const btn = document.getElementById('sync-btn');
  btn.textContent = '‚è≥';
  btn.style.opacity = '0.6';
  await syncFromSheets();
  renderTasks(); renderNotes(); renderTransactions();
  updateFinanceTotals(); updateDashboard();
  btn.textContent = '‚úÖ';
  setTimeout(() => { btn.textContent = 'üîÑ'; btn.style.opacity = '1'; }, 1500);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  initDate();
  showTab('dashboard');
  loadDB(() => {
    autoResetRecurringTasks(); // Reset recurring tasks daily
    // Check for tasks passed from bot via start_param
    const startParam = window.Telegram?.WebApp?.initDataUnsafe?.start_param;
    if(startParam) {
      try {
        const decoded = decodeURIComponent(atob(startParam));
        const newTask = JSON.parse(decoded);
        if(newTask.type === 'task' && newTask.text) {
          const exists = tasks.find(t => t.source_id === newTask.source_id);
          if(!exists) {
            tasks.push({
              id: Date.now(),
              source_id: newTask.source_id,
              text: newTask.text,
              date: newTask.date || '',
              priority: newTask.priority || 'MID',
              done: false,
              recurring: newTask.recurring || null,
            });
            saveDB();
          }
        }
      } catch(e) {}
    }
    renderTasks();
    renderNotes();
    renderJobs();
    renderInvestments();
    renderTransactions();
    updateFinanceTotals();
    updateDashboard();
  });
});
</script>
</body>
</html>
